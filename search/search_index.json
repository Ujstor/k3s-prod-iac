{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"K3S Single Node Multi Cluster IaC","text":"<p>Minimal k3s single node deployment on Hetzner Cloud with Terraform and Ansible as multi cluster configuration managed with ArgoCD.</p> <p></p> <p>K3s is stripped down to minimal components. The only components we have are CoreDNS, local-path-provisioner, and metrics-server. Everything else is disabled and configured with custom Helm charts.</p> <p></p> <p>The clusters will be automatically bootstrapped and managed with ArgoCD.</p>"},{"location":"#prerequisites","title":"Prerequisites","text":"<p>Before you begin, ensure you have the following:</p> <ul> <li>Hetzner Cloud account (20$ free credits)</li> <li>Terraform</li> <li>Helm</li> <li>kubectl</li> <li>K9s (optional but recommended)</li> </ul> <p>The main idea is to have a primary single-node operations K3s cluster that has ArgoCD and an App of Apps pattern to manage both operations and other K3s single or multi-node clusters.</p> <p>Helm charts and Terraform modules are custom-made with the intention to be reusable and reconfigurable:</p> <ul> <li>Helm Charts System</li> <li>Helm Charts Apps</li> <li>Helm Charts Github Apps</li> <li>Terraform Hetzner Modules</li> </ul>"},{"location":"k3s0-ops-components/mailserver/","title":"Mailserver","text":"<p>The MailServer chart deploys a docker-mailserver implementation. While the configuration can be very complex, the official documentation is very good and serves as an excellent guide for understanding and properly configuring the mailserver.</p>"},{"location":"k3s0-ops-components/mailserver/#preconfig","title":"Preconfig","text":""},{"location":"k3s0-ops-components/mailserver/#dns-records","title":"DNS Records","text":"<p>The node-infra directory, located within the IaC folder, contains Cloudflare DNS records, specifically MX and A records.</p> <pre><code>    mx = {\n      zone_id  = var.cloudflare_zone_id\n      name     = \"@\"\n      content  = \"mail.ujstor.com\"\n      type     = \"MX\"\n      priority = 10\n    }\n    mail = {\n      zone_id = var.cloudflare_zone_id\n      name    = \"mail\"\n      content = module.floating_ip.floating_ip_status.ip-1.ip\n      type    = \"A\"\n      ttl     = 60\n      proxied = false\n    }\n</code></pre>"},{"location":"k3s0-ops-components/mailserver/#cert-issuer","title":"Cert Issuer","text":"<p>We can't use the ClusterIssuer that is already deployed because there is no ingress deployed with the mailserver (the service type is LoadBalancer).</p> <p>For this reason, we need to:</p> <ul> <li>Create an API token with read/write permissions</li> <li>Add data to the Issuer object</li> <li>Deploy it in the namespace where the mailserver chart will be deployed with Helm</li> </ul> <pre><code>apiVersion: cert-manager.io/v1\nkind: Issuer\nmetadata:\n  name: letsencrypt-issuer\n  namespace: mailserver\nspec:\n  acme:\n    server: https://acme-v02.api.letsencrypt.org/directory\n    privateKeySecretRef:\n      name: letsencrypt-key\n    solvers:\n    - dns01:\n        cloudflare:\n          apiTokenSecretRef:\n            name: mailserver-issuer\n            key: api-key\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mailserver-issuer\n  namespace: mailserver\ntype: Opaque\nstringData:\n  api-key: &lt;Cloudflare-api-key&gt;\n</code></pre> <p>The chart needs to reference:</p> <ul> <li>The mail domain in the deployment.env.OVERRIDE_HOSTNAME section</li> <li>The issuer name in certificate.issuerRef.name section</li> <li>Specifying the certificate name is enough, and the Certificate object will be created</li> </ul> <pre><code>dockermailserver:\n  deployment:\n    env:\n      OVERRIDE_HOSTNAME: mail.ujstor.com\n  certificate: mailserver-tls\n\ncertificates:\n  organization: Ujstor\n  duration: 2160h\n  renewBefore: 360h\n  issuerRef:\n    name: letsencrypt-issuer\n    kind: Issuer\n</code></pre> <p>The Certificate object is under the templates directory and it will automatically create and mount the mailserver-tls secret to the pod.</p>"},{"location":"k3s0-ops-components/mailserver/#network-config","title":"Network config","text":"<p>The service type is LoadBalancer, so we need to add an additional floating IP to the server. This can be achieved with terraform-hetzner-modules that I am using for provisioning Hetzner infrastructure.</p> <pre><code>module \"floating_ip\" {\n  source = \"github.com/Ujstor/terraform-hetzner-modules//modules/network/floating_ip?ref=v0.0.8\"\n\n  floating_ip_config = {\n    ip-1 = {\n      server_id       = module.k3s_prod.server_info.k3s0-ops.id\n      server_location = module.k3s_prod.server_info.k3s0-ops.location\n    }\n  }\n}\n</code></pre> <p>And once we have the IP, we need to add it to the MetalLB IPAddressPool.</p> <pre><code>Outputs:\n\nfloating_ip_info = {\n  \"ip-1\" = {\n    \"ip\" = \"49.13.32.42\"\n  }\n}\nserver_info = {\n  \"k3s0-ops\" = {\n    \"id\" = \"57518060\"\n    \"ip\" = \"188.245.179.200\"\n    \"location\" = \"nbg1\"\n    \"status\" = \"running\"\n  }\n  \"k3s1-app\" = {\n    \"id\" = \"57518059\"\n    \"ip\" = \"49.13.159.158\"\n    \"location\" = \"nbg1\"\n    \"status\" = \"running\"\n  }\n}\n</code></pre> <pre><code>metallb-config:\n  ipAddressPool:\n    addresses:\n     - 188.245.179.200/32\n     - 49.13.32.42/32\n\n  l2Advertisement:\n    enabled: true\n</code></pre> <p>Push to main and ArgoCD will provision MetalLB and mailserver deployment.</p>"},{"location":"k3s0-ops-components/mailserver/#mailserver-configuration","title":"MailServer configuration","text":"<p>Once deployed, you will have 120 seconds to create an account. I am using k9s, and by pressing 's' on the pod, you will have an active shell. There are other ways to do this in a more automated way, but for now we are following these steps manually so we can better understand what is happening.</p> <p>Execute the command to create an email account.</p> <pre><code>setup email add admin@ujstor.com password1234\n\nsetup email list\n</code></pre> <p>This is a minimal configuration. Test it with an application that supports SMTP - for example, Uptime Kuma can send you notifications when your website endpoint is unavailable.</p> <p>Forwarding email to Gmail with a minimal configuration will not work. Looking at the logs, you can see the issue: your SMTP server successfully accepts and processes the email, but it's rejected by Gmail's SMTP server. While your server accepts the message and queues it, delivery to Gmail fails.</p> <p>Pod logs:</p> <pre><code>postfix/smtp[5465]: 940A663D054: to=&lt;astipan@gmail.com&gt;, relay=gmail-smtp-in.l.google.com[142.251.31.26]:25, delay=0.48, delays=0.08/0.02/0.05/0.33, dsn=5.7\n</code></pre> <p>The dsn=5.7 error code suggests that Gmail is rejecting the email due to authentication/security requirements.</p> <p>To fix this, you should Generate DKIM key:</p>"},{"location":"k3s0-ops-components/mailserver/#dkim-keys","title":"DKIM keys","text":"<p>Create active shell in pod, and execute:</p> <pre><code>setup config dkim\n2024-12-22 19:45:58+00:00 INFO  rspamd-dkim: Creating DKIM keys of type 'rsa' and length '2048' with selector 'mail' for domain 'ujstor.com'\n2024-12-22 19:45:59+00:00 INFO  rspamd-dkim: Successfully created DKIM keys\n2024-12-22 19:45:59+00:00 INFO  rspamd-dkim: Supplying a default configuration (to '/tmp/docker-mailserver/rspamd/override.d/dkim_signing.conf')\nrspamd: stopped\nrspamd: started\n2024-12-22 19:45:59+00:00 INFO  rspamd-dkim: Here is the content of the TXT DNS record mail._domainkey.ujstor.com that you need to create:\n\nv=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlKuh1diP0S5sKdXtlMnjqtDijNqXAHnsHo4jRySPS8TgjwJIKuKa8jq4LlsStZoUXcCEGlqJuBnUqVUeOoBkCrJRqQqh3sg1YgPTzKIfqb6Yq10x6N//BftlgvIB7y0I/UdcE6S3i4Umub0xB6/A7pY6tXtqqlT91jDvl1gN2wugQF0unsPrqzVyplOkS8mT2Uz08gtrgf3Aa7gQ+IQo93hciLH0I/Ik9LK5Lfj62J4SfMUAAQBw5gSETi0ZIlzd9xkziBYpx6xDDjqEp8L2fbejstYlERMDIQOaKibvCwG2VF52oIMkNuu7R4qpChjsnbvFqa7hSQCfAluwjl2bfwIDAQAB\n\nrspamd: stopped\nrspamd: started\n</code></pre> <p>Then create new TXT record in Cloudflare DNS with the content provided under iac and run terrafrom apply:</p> <pre><code>    mail-dkms = {\n      zone_id = var.cloudflare_zone_id\n      name    = \"mail._domainkey.ujstor.com\"\n      content = \"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlKuh1diP0S5sKdXtlMnjqtDijNqXAHnsHo4jRySPS8TgjwJIKuKa8jq4LlsStZoUXcCEGlqJuBnUqVUeOoBkCrJRqQqh3sg1YgPTzKIfqb6Yq10x6N//BftlgvIB7y0I/UdcE6S3i4Umub0xB6/A7pY6tXtqqlT91jDvl1gN2wugQF0unsPrqzVyplOkS8mT2Uz08gtrgf3Aa7gQ+IQo93hciLH0I/Ik9LK5Lfj62J4SfMUAAQBw5gSETi0ZIlzd9xkziBYpx6xDDjqEp8L2fbejstYlERMDIQOaKibvCwG2VF52oIMkNuu7R4qpChjsnbvFqa7hSQCfAluwjl2bfwIDAQAB\"\n      type    = \"TXT\"\n      ttl     = 1\n    }\n</code></pre>"},{"location":"k3s0-ops-components/mailserver/#test","title":"Test","text":"<p>If you now send an email to Gmail, it will be accepted and delivered.</p> <p>gmass SMTP test logs</p> <pre><code>Connected to smtp://mail.ujstor.com:587/?starttls=when-available\n&lt;&lt; 220 mail.ujstor.com ESMTP\n&gt;&gt; EHLO [172.31.11.248]\n&lt;&lt; 250-mail.ujstor.com\n&lt;&lt; 250-PIPELINING\n&lt;&lt; 250-SIZE 10240000\n&lt;&lt; 250-ETRN\n&lt;&lt; 250-STARTTLS\n&lt;&lt; 250-ENHANCEDSTATUSCODES\n&lt;&lt; 250-8BITMIME\n&lt;&lt; 250-DSN\n&lt;&lt; 250 CHUNKING\n&gt;&gt; STARTTLS\n&lt;&lt; 220 2.0.0 Ready to start TLS\n&gt;&gt; EHLO [172.31.11.248]\n&lt;&lt; 250-mail.ujstor.com\n&lt;&lt; 250-PIPELINING\n&lt;&lt; 250-SIZE 10240000\n&lt;&lt; 250-ETRN\n&lt;&lt; 250-AUTH PLAIN LOGIN\n&lt;&lt; 250-AUTH=PLAIN LOGIN\n&lt;&lt; 250-ENHANCEDSTATUSCODES\n&lt;&lt; 250-8BITMIME\n&lt;&lt; 250-DSN\n&lt;&lt; 250 CHUNKING\n&gt;&gt; AUTH PLAIN AGFkbWluQHVqc3Rvci5jb20AcGFzc3dvcmQxMjM0\n&lt;&lt; 235 2.7.0 Authentication successful\n&gt;&gt; MAIL FROM:&lt;admin@ujstor.com&gt; SIZE=551\n&gt;&gt; RCPT TO:&lt;astipan@gmail.com&gt;\n&lt;&lt; 250 2.1.0 Ok\n&lt;&lt; 250 2.1.5 Ok\n&gt;&gt; DATA\n&lt;&lt; 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;\n&gt;&gt; From: admin@ujstor.com\n&gt;&gt; Date: Sun, 22 Dec 2024 19:56:52 \ud34d\n&gt;&gt; Subject: SMTP test from mail.ujstor.com\n&gt;&gt; Message-Id: &lt;NDGOPQ70YOU4.5VT4A0G77RFU3@WIN-AUIR3RRGP88&gt;\n&gt;&gt; To: astipan@gmail.com\n&gt;&gt; MIME-Version: 1.0\n&gt;&gt; Content-Type: multipart/alternative; boundary=\"=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==\"\n&gt;&gt;\n&gt;&gt; --=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==\n&gt;&gt; Content-Type: text/plain; charset=utf-8\n&gt;&gt;\n&gt;&gt; Test message\n&gt;&gt; --=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==\n&gt;&gt; Content-Type: text/html; charset=utf-8\n&gt;&gt; Content-Id: &lt;NDGOPQ70YOU4.8C46H6CU77TD@WIN-AUIR3RRGP88&gt;\n&gt;&gt;\n&gt;&gt; &lt;b&gt;Test message&lt;/b&gt;\n&gt;&gt; --=-qL2\uf2ba\ud57a\u8ffc\ucf8d\u7618\ue5d5==--\n&gt;&gt; .\n&lt;&lt; 250 2.0.0 Ok: queued as EF1B7645EE7\n</code></pre> <p>Pod logs</p> <pre><code>24-12-22 19:40:43+00:00 INFO  start-mailserver.sh: Welcome to docker-mailserver v14.0.0                                                                                                                                                                                                                                                                     \u2502\n\u2502 2024-12-22 19:40:43+00:00 INFO  start-mailserver.sh: Checking configuration                                                                                                                                                                                                                                                                               \u2502\n\u2502 2024-12-22 19:40:43+00:00 INFO  start-mailserver.sh: Configuring mail server                                                                                                                                                                                                                                                                              \u2502\n\u2502 2024-12-22 19:40:43+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (120s left for account creation before shutdown)                                                                                                                                                                                                 \u2502\n\u2502 2024-12-22 19:40:53+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (110s left for account creation before shutdown)                                                                                                                                                                                                 \u2502\n\u2502 2024-12-22 19:41:03+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (100s left for account creation before shutdown)                                                                                                                                                                                                 \u2502\n\u2502 2024-12-22 19:41:13+00:00 WARN  start-mailserver.sh: You need at least one mail account to start Dovecot (90s left for account creation before shutdown)                                                                                                                                                                                                  \u2502\n\u2502 2024-12-22 19:41:24+00:00 INFO  start-mailserver.sh: Starting daemons                                                                                                                                                                                                                                                                                     \u2502\n\u2502 2024-12-22 19:41:27+00:00 INFO  start-mailserver.sh: mail.ujstor.com is up and running                                                                                                                                                                                                                                                                    \u2502\n\u2502 tail: inotify cannot be used, reverting to polling: Too many open files                                                                                                                                                                                                                                                                                   \u2502\n\u2502 2024-12-22T19:41:27.823323+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/postfix-script[932]: starting the Postfix mail system                                                                                                                                                                                                               \u2502\n\u2502 2024-12-22T19:41:27.840527+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/master[933]: daemon started -- version 3.7.10, configuration /etc/postfix                                                                                                                                                                                           \u2502\n\u2502 2024-12-22 19:45:59,990 WARN stopped: rspamd (terminated by SIGTERM)                                                                                                                                                                                                                                                                                      \u2502\n\u2502 2024-12-22T19:56:51.364820+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: connect from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181]                                                                                                                                                             \u2502\n\u2502 2024-12-22T19:56:52.324327+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: Anonymous TLS connection established from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181]: TLSv1.2 with cipher DHE-RSA-AES128-GCM-SHA256 (128/128 bits)                                                                  \u2502\n\u2502 2024-12-22T19:56:52.979665+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: EF1B7645EE7: client=ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181], sasl_method=PLAIN, sasl_username=admin@ujstor.com                                                                                                   \u2502\n\u2502 2024-12-22T19:56:53.355001+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/sender-cleanup/cleanup[4477]: EF1B7645EE7: message-id=&lt;NDGOPQ70YOU4.5VT4A0G77RFU3@WIN-AUIR3RRGP88&gt;                                                                                                                                                                  \u2502\n\u2502 2024-12-22T19:56:53.355079+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/sender-cleanup/cleanup[4477]: EF1B7645EE7: replace: header MIME-Version: 1.0 from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181]; from=&lt;admin@ujstor.com&gt; to=&lt;astipan@gmail.com&gt; proto=ESMTP helo=&lt;[172.31.11.248]&gt;: MIME-Version: 1.0          \u2502\n\u2502 2024-12-22T19:56:53.580667+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/qmgr[935]: EF1B7645EE7: from=&lt;admin@ujstor.com&gt;, size=585, nrcpt=1 (queue active)                                                                                                                                                                                   \u2502\n\u2502 2024-12-22T19:56:53.722477+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/smtp[4478]: Trusted TLS connection established to gmail-smtp-in.l.google.com[142.251.31.27]:25: TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits) key-exchange X25519 server-signature ECDSA (prime256v1) server-digest SHA256                              \u2502\n\u2502 2024-12-22T19:56:53.761942+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/submission/smtpd[4467]: disconnect from ec2-54-212-131-181.us-west-2.compute.amazonaws.com[54.212.131.181] ehlo=2 starttls=1 auth=1 mail=1 rcpt=1 data=1 commands=7                                                                                                 \u2502\n\u2502 2024-12-22T19:56:54.285473+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/smtp[4478]: EF1B7645EE7: to=&lt;astipan@gmail.com&gt;, relay=gmail-smtp-in.l.google.com[142.251.31.27]:25, delay=1.3, delays=0.62/0.03/0.14/0.54, dsn=2.0.0, status=sent (250 2.0.0 OK  1734897414 a640c23a62f3a-aac0f040f87si490882066b.477 - gsmtp)                     \u2502\n\u2502 2024-12-22T19:56:54.286079+00:00 mailserver-dockermailserver-7f75d8656b-78f5h postfix/qmgr[935]: EF1B7645EE7: removed \n</code></pre>"},{"location":"k3s0-ops-components/mailserver/#test-tools","title":"Test tools","text":"<ul> <li>The complete IP check for sending Mailservers: https://multirbl.valli.org/</li> <li>SMTP test: https://www.gmass.co/smtp-test</li> </ul>"},{"location":"k3s0-ops-components/mailserver/#useful-commands","title":"Useful commands","text":"<pre><code>setup email add admin@example.com passwd123\nsetup email add info@example.com passwd123\nsetup alias add admin@example.com external-account@gmail.com\nsetup alias add info@example.com external-account@gmail.com\nsetup email list\nsetup alias list\nsetup email del admin@example.com\n</code></pre>"},{"location":"quick-start/ansible/","title":"Ansible","text":"<p>Ansible is not listed in requirements for a reason. We have encapsulated Ansible configuration and run it in a Docker container.</p> <p>From the project root, run the following command to build the Docker image:</p> <pre><code>docker build -t ansible-k3s-single-node-multi-cluster ./iac/ansible/k3s-deploy\n</code></pre>"},{"location":"quick-start/ansible/#inventory","title":"Inventory","text":"<p>To achieve the minimal K3s deployment mentioned earlier, note these key configurations in the inventory file:</p> <pre><code>server:\n  children:\n    k3s0:\n      hosts:\n        api.k3s0.ujstor.com:\n          api_endpoint: api.k3s0.ujstor.com\n          k3s_control_node: true\n          k3s_server_init_node: true\n          server_group: \"k3s0\"\n    k3s1:\n      hosts:\n        api.k3s1.ujstor.com:\n          api_endpoint: api.k3s1.ujstor.com\n          k3s_control_node: true\n          k3s_server_init_node: true\n          server_group: \"k3s1\"\n  vars:\n    k3s_version: v1.31.1+k3s1\n    extra_server_args: &gt;-\n      --cluster-cidr=10.255.0.0/16\n      --service-cidr=10.254.0.0/16\n      --disable servicelb\n      --disable traefik\n      --flannel-backend=none\n      --egress-selector-mode=disabled\n      --disable-cloud-controller\n      --disable-helm-controller\n      --disable-network-policy\n      --disable-kube-proxy\n      --tls-san {{ api_endpoint }}\n</code></pre>"},{"location":"quick-start/ansible/#run-ansible","title":"Run Ansible","text":"<p>We are mounting SSH keys (created by Terraform) and the inventory file to the container:</p> <pre><code>docker run --rm -it \\\n    -v $(pwd)/iac/ansible/inventory_k3s_deploy.yml:/config/inventory.yml \\\n    -v $(pwd)/iac/terraform/nodes-infra/.ssh/k3s_prod_hetzner_ssh_key:/secrets/ssh_key \\\n    -v $(pwd)/iac/terraform/nodes-infra/.ssh/k3s_prod_hetzner_ssh_key.pub:/secrets/ssh_key.pub \\\n    ansible-k3s-single-node-multi-cluster\n</code></pre> <p>Ansible is custom configured in ansible.cfg, which is why mounting points can be different from classic Ansible configuration.</p> <pre><code>ansible-playbook k3s_deploy.yml\n</code></pre>"},{"location":"quick-start/ansible/#kubeconfig","title":"Kubeconfig","text":"<p>After the Ansible playbook finishes, you will have a kubeconfig file in the Docker container's root. These files are used to access the K3s clusters. Save them and later, you can back up these files in the same MinIO tenant as your Terraform state and SSH keys.</p> <pre><code>cat kubeconfig-*\n</code></pre> <p>In the next steps, we will deploy Cilium and ArgoCD on the K3s0 cluster and see real magic happen.</p>"},{"location":"quick-start/helm/","title":"Helm","text":"<p>One more thing needs to be preconfigured before we can apply the Argo App of Apps. Take IPs from the Terraform output and add them to metallb-config.yaml file in k3s0-ops and k3s1-app Helm charts. These IPs will be used by MetalLB to assign external IPs to services.</p> <pre><code>metallb-config:\n  ipAddressPool:\n    addresses:\n     - 192.168.1.1/32\n\n  l2Advertisement:\n    enabled: true\n</code></pre> <p>Push changes to the GitHub repository and ArgoCD will apply them after the next steps.</p>"},{"location":"quick-start/helm/#install-cilium","title":"Install Cilium:","text":"<p>Change directory to the k3s0-ops Cilium Helm chart config and run:</p> <pre><code>helm install cilium . -n kube-system\n</code></pre> <p>Observe in k9s when networking is applied: CoreDNS, local-path-provisioner, and metrics-server pods will be running and cluster IPs will be assigned.</p> <p></p>"},{"location":"quick-start/helm/#install-argo-cd","title":"Install Argo CD:","text":"<p>Create a namespace for Argo CD:</p> <pre><code>kubectl create namespace gitops\n</code></pre> <p>Change directory to the k3s0-ops Argo CD Helm chart config and run:</p> <pre><code>helm install argocd . -n gitops\n</code></pre> <p>Check when ArgoCD is installed, you can do port-forwarding to the ArgoCD pod and log in with the password that can be grabbed from the secrets (use k9s, it's easier than raw kubectl commands).</p> <p></p> <p>Finaly apply k3s0 <code>aoa.yaml</code> in the <code>gitops</code> namespace:</p> <pre><code>kubectl apply -f cluster/k3s0-ops/helm/aoa.yaml -n gitops\n</code></pre> <p>In 5 minutes, other components of the K3s0 cluster will be deployed.</p>"},{"location":"quick-start/helm/#add-k3s1-cluster-to-argocd","title":"Add K3s1 cluster to ArgoCD","text":"<p>There are a couple of ways to add K3s1 to ArgoCD. The easiest way is to use the CLI by referencing the K3s1 kubeconfig file:</p> <pre><code>argocd login argocd.k3s0.ujstor.com\nargocd cluster add default --kubeconfig ~/.kube/k3s1-app --name default --grpc-web\n</code></pre> <p>and apply k3s1 <code>aoa.yaml</code> in k3s0 to deploy the K3s1 cluster:</p> <pre><code>kubectl apply -f cluster/k3s1-app/helm/aoa.yaml -n gitops\n</code></pre> <p>Cluster K3s1 will be deployed for 0 to hero.</p>"},{"location":"quick-start/helm/#note","title":"Note","text":"<p>Alternativley you can crate service account and token for ArgoCD in k3s1:</p> <pre><code>apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: argocd-manager\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: argocd-manager-role\nrules:\n- apiGroups:\n  - '*'\n  resources:\n  - '*'\n  verbs:\n  - '*'\n- nonResourceURLs:\n  - '*'\n  verbs:\n  - '*'\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: argocd-manager-role-binding\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: argocd-manager-role\nsubjects:\n- kind: ServiceAccount\n  name: argocd-manager\n  namespace: kube-system\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: argocd-manager-token\n  namespace: kube-system\n  annotations:\n    kubernetes.io/service-account.name: argocd-manager\ntype: kubernetes.io/service-account-token\n</code></pre> <p>and k3s1-cluster-secret.yaml in k3s0:</p> <pre><code>#k3s1\nca=$(kubectl get -n kube-system secret/argocd-manager-token -o jsonpath='{.data.ca\\.crt}')\ntoken=$(kubectl get -n kube-system secret/argocd-manager-token -o jsonpath='{.data.token}' | base64 --decode)\n\n</code></pre> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: k3s1-cluster-secret\n  labels:\n    argocd.argoproj.io/secret-type: cluster\ntype: Opaque\nstringData:\n  name: cluster-1\n  server: https://api.k8s1.ujstor.com:6443\n  config: |\n    {\n      \"bearerToken\": \"${token}\",\n      \"tlsClientConfig\": {\n        \"serverName\": \"https://api.k8s1.ujstor.com\",\n        \"caData\": \"${ca}\"\n      }\n    }\n</code></pre> <pre><code>#k3s0\nkubectl apply -f k3s1-cluster-secret.yaml -n gitops\n</code></pre>"},{"location":"quick-start/overview/","title":"Overview","text":"<p>First step is to create API key in the Hetzner Cloud Console and Cloudflare API key in the Cloudflare dashboard for domain management. Import them as secrets in ./iac/terraform/nodes-infra/.auto.tfvars file:</p> <pre><code>hcloud_token = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\ncloudflare_api_token = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\ncloudflare_zone_id   = \"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\"\n</code></pre> <p>If you use more than one domain, as in my example, do the same thing for every Terraform directory that manages a domain.</p>"},{"location":"quick-start/overview/#order-of-execution","title":"Order of Execution","text":"<p>We need to use Terraform, Ansible, Helm and kubectl to deploy the infrastructure:</p> <ol> <li>We are creating SSH keys, network, and nodes in Hetzner Cloud with Terraform</li> <li>Ansible will deploy K3s on the nodes</li> <li>On K3s0, we will deploy Cilium and ArgoCD</li> <li>Apply K3s0 App of Apps to finish the setup and bootstrap</li> <li>Add K3s1 cluster to ArgoCD</li> <li>Apply k3s1 App of Apps in k3s0 to deploy the K3s1 cluster</li> </ol>"},{"location":"quick-start/overview/#helm-charts-configuration","title":"Helm charts configuration","text":"<p>The Helm charts are configured in values.yaml and are imported as dependencies from a repository. They contain my personal configuration, but you can modify them to suit your needs. Do not blindly apply them - check every configuration. Each of them references my domain, and this repository is used as a production GitOps repository.</p>"},{"location":"quick-start/overview/#project-tree","title":"Project tree","text":"<pre><code>[4.0K]  ./\n\u251c\u2500\u2500 [4.0K]  cluster/\n\u2502   \u251c\u2500\u2500 [4.0K]  k3s0-ops/\n\u2502   \u2502   \u2514\u2500\u2500 [4.0K]  helm/\n\u2502   \u2502       \u251c\u2500\u2500 [4.0K]  app-of-apps/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 595]  100_system_cilium.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 734]  110_system_metallb_operator.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 738]  120_system_metallb_config.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 760]  150_system_ingress_nginx.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 763]  200_system_cert_manager.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 739]  300_system_cluster_issuer.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 681]  410_system_minio_operator.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 685]  420_system_gitlab_operator.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 689]  500_system_external_secrets.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 649]  600_system_argocd.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 730]  700_system_prometheus_grafana.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 640]  900_app_gitea.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 665]  910_app_uptime_kuma.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 661]  920_app_mailserver.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 683]  970_app_harbor.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 645]  980_app_gitlab.yaml\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [ 698]  990_app_s3_storage.yaml\n\u2502   \u2502       \u2502   \u2514\u2500\u2500 [ 622]  AppProject.yaml\n\u2502   \u2502       \u251c\u2500\u2500 [4.0K]  apps/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  gitea/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  gitlab/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  harbor/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  mailserver/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  s3-storage/\n\u2502   \u2502       \u2502   \u2514\u2500\u2500 [4.0K]  uptime-kuma/\n\u2502   \u2502       \u251c\u2500\u2500 [4.0K]  system/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  argocd/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  cert-manager/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  cilium/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  cluster-issuer/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  external-secrets/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  gitlab-operator/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  ingress-nginx/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  metallb-config/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  metallb-operator/\n\u2502   \u2502       \u2502   \u251c\u2500\u2500 [4.0K]  minio-operator/\n\u2502   \u2502       \u2502   \u2514\u2500\u2500 [4.0K]  prometheus-grafana/\n\u2502   \u2502       \u251c\u2500\u2500 [ 474]  aoa.yaml\n\u2502   \u2502       \u251c\u2500\u2500 [ 373]  k3s1-cluster-secret-example.yaml\n\u2502   \u2502       \u2514\u2500\u2500 [2.0K]  k3s1-cluster-secret.yaml\n\u2502   \u2514\u2500\u2500 [4.0K]  k3s1-app/\n\u2502       \u2514\u2500\u2500 [4.0K]  helm/\n\u2502           \u251c\u2500\u2500 [4.0K]  app-of-apps/\n\u2502           \u2502   \u251c\u2500\u2500 [ 551]  100_system_cilium.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 736]  110_system_metallb_operator.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 740]  120_system_metallb_config.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 762]  150_system_ingress_nginx.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 765]  200_system_cert_manager.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 741]  300_system_cluster_issuer.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 724]  400_system_postgres_operator.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 683]  410_system_minio_operator.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 691]  500_system_external_secrets.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 659]  900_app_portfolio.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 699]  910_app_github_readme_stats_api.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 671]  920_app_streamlit_wh.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 655]  925_app_probit_api.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 786]  930_app_todo_go_htmx.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 651]  935_app_fastapi.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 667]  940_app_notes_flask.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 667]  945_app_todo_django.yaml\n\u2502           \u2502   \u251c\u2500\u2500 [ 926]  950_app_plausible_analytics.yaml\n\u2502           \u2502   \u2514\u2500\u2500 [ 668]  960_app_wordpress_ds.yaml\n\u2502           \u251c\u2500\u2500 [4.0K]  apps/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  fastapi/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  github-readme-stats/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  notes-flask/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  plausible-analytics/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  portfolio/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  probit-api/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  streamlit-wh/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  todo-django/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  todo-go-htmx/\n\u2502           \u2502   \u2514\u2500\u2500 [4.0K]  wordpress-ds/\n\u2502           \u251c\u2500\u2500 [4.0K]  system/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  cert-manager/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  cilium/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  cluster-issuer/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  external-secrets/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  ingress-nginx/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  metallb-config/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  metallb-operator/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  minio-operator/\n\u2502           \u2502   \u251c\u2500\u2500 [4.0K]  postgres-operator/\n\u2502           \u2502   \u2514\u2500\u2500 [4.0K]  prometheus-grafana/\n\u2502           \u251c\u2500\u2500 [ 474]  aoa.yaml\n\u2502           \u2514\u2500\u2500 [ 805]  serviceAcc.yaml\n\u251c\u2500\u2500 [4.0K]  iac/\n\u2502   \u251c\u2500\u2500 [4.0K]  ansible/\n\u2502   \u2502   \u251c\u2500\u2500 [4.0K]  k3s-deploy/\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 [4.0K]  roles/\n\u2502   \u2502   \u2502   \u2502   \u2514\u2500\u2500 [4.0K]  common/\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 [ 239]  ansible.cfg\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 [ 459]  Dockerfile\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 [1.4K]  k3s_deploy.yml\n\u2502   \u2502   \u2502   \u251c\u2500\u2500 [ 207]  k3s_remove.yml\n\u2502   \u2502   \u2502   \u2514\u2500\u2500 [ 169]  requirements.yml\n\u2502   \u2502   \u2514\u2500\u2500 [ 827]  inventory_k3s_deploy.yml\n\u2502   \u2514\u2500\u2500 [4.0K]  terraform/\n\u2502       \u251c\u2500\u2500 [4.0K]  cloudflare-dns-astipan/\n\u2502       \u2502   \u251c\u2500\u2500 [  65]  dependencies.tf\n\u2502       \u2502   \u251c\u2500\u2500 [1.7K]  main.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 847]  terrafrom.tf\n\u2502       \u2502   \u2514\u2500\u2500 [ 329]  variables.tf\n\u2502       \u251c\u2500\u2500 [4.0K]  cloudflare-dns-ds/\n\u2502       \u2502   \u251c\u2500\u2500 [  65]  dependencies.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 551]  main.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 842]  terrafrom.tf\n\u2502       \u2502   \u2514\u2500\u2500 [ 329]  variables.tf\n\u2502       \u251c\u2500\u2500 [4.0K]  nodes-infra/\n\u2502       \u2502   \u251c\u2500\u2500 [2.4K]  cloudflare_dns.tf\n\u2502       \u2502   \u251c\u2500\u2500 [1.8K]  main.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 142]  output.tf\n\u2502       \u2502   \u251c\u2500\u2500 [   0]  terraform.tfstate\n\u2502       \u2502   \u251c\u2500\u2500 [ 37K]  terraform.tfstate.backup\n\u2502       \u2502   \u251c\u2500\u2500 [ 911]  terrafrom.tf\n\u2502       \u2502   \u2514\u2500\u2500 [ 329]  variables.tf\n\u2502       \u251c\u2500\u2500 [4.0K]  s3-kubeconfig-backup/\n\u2502       \u2502   \u251c\u2500\u2500 [ 649]  main.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 120]  outputs.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 895]  terraform.tf\n\u2502       \u2502   \u2514\u2500\u2500 [ 159]  variables.tf\n\u2502       \u251c\u2500\u2500 [4.0K]  s3-ssh-keys-backup/\n\u2502       \u2502   \u251c\u2500\u2500 [ 613]  main.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 120]  outputs.tf\n\u2502       \u2502   \u251c\u2500\u2500 [ 896]  terraform.tf\n\u2502       \u2502   \u251c\u2500\u2500 [   0]  terraform.tfstate\n\u2502       \u2502   \u251c\u2500\u2500 [6.5K]  terraform.tfstate.backup\n\u2502       \u2502   \u2514\u2500\u2500 [ 157]  variables.tf\n\u2502       \u2514\u2500\u2500 [4.0K]  s3-tf-state/\n\u2502           \u251c\u2500\u2500 [ 254]  main.tf\n\u2502           \u251c\u2500\u2500 [ 120]  outputs.tf\n\u2502           \u251c\u2500\u2500 [ 427]  terraform.tf\n\u2502           \u251c\u2500\u2500 [3.0K]  terraform.tfstate\n\u2502           \u251c\u2500\u2500 [3.0K]  terraform.tfstate.backup\n\u2502           \u2514\u2500\u2500 [ 165]  variables.tf\n\u251c\u2500\u2500 [ 191]  docker-config.yml\n\u251c\u2500\u2500 [2.6K]  docker_tag.sh*\n\u251c\u2500\u2500 [1.0K]  LICENSE\n\u251c\u2500\u2500 [2.2K]  Makefile\n\u2514\u2500\u2500 [1.6K]  README.md\n</code></pre>"},{"location":"quick-start/terraform/","title":"Terrafrom","text":"<p>In the node-infra directory under IAC, main.tf defines what infrastructure will be created. The cloudflare_dns.tf is a module that creates DNS records in Cloudflare. DNS records use wildcards for apps that are used as internal tools not available to the public. We also have specific domains for the Kubernetes API, which are referenced in the Ansible inventory file. Other records are for the mail server and other services.</p> <p>Future security improvement: all internal services will require OpenVPN connection for access.</p>"},{"location":"quick-start/terraform/#preconfiguration","title":"Preconfiguration","text":""},{"location":"quick-start/terraform/#terraform-backend","title":"Terraform backend","text":"<p>Current terraform.tf, where providers are defined, assumes that you have a MinIO S3 bucket deployed for storing Terraform state. On the first run, when you don't have your infrastructure up and running, comment out the S3 backend.</p> <pre><code>terraform {\n  # backend \"s3\" {\n  #   bucket                      = \"tf-state-k3s0-k3s1-cluster\"\n  #   key                         = \"nodes-infra-tfstate/terraform.tfstate\"\n  #   region                      = \"us-east-1\"\n  #   skip_credentials_validation = true\n  #   skip_metadata_api_check     = true\n  #   skip_region_validation      = true\n  #   skip_requesting_account_id  = true\n  #   force_path_style            = true\n  #   endpoint                    = \"https://s3.k3s0.ujstor.com\"\n  # }\n  required_providers {\n    hcloud = {\n      source  = \"hetznercloud/hcloud\"\n      version = \"~&gt; 1.47\"\n    }\n    tls = {\n      source  = \"hashicorp/tls\"\n      version = \"~&gt; 4.0\"\n    }\n    cloudflare = {\n      source  = \"cloudflare/cloudflare\"\n      version = \"~&gt; 4.37\"\n    }\n  }\n  required_version = \"&gt;= 1.0.0, &lt; 2.0.0\"\n}\n\nprovider \"hcloud\" {\n  token = var.hcloud_token\n}\n\nprovider \"cloudflare\" {\n  api_token = var.cloudflare_api_token\n}\n</code></pre>"},{"location":"quick-start/terraform/#ssh-keys","title":"SSH Keys","text":"<p>SSH keys will be automatically generated when you run <code>terraform apply</code>, but Terraform expects an .ssh directory inside the node-infra directory. Later, you can back up your keys in the same MinIO tenant as your Terraform state. Check config in s3-ssh-keys-backup dir.</p>"},{"location":"quick-start/terraform/#create-infrastructure","title":"Create Infrastructure","text":"<p>Once you have the API keys in the .auto.tfvars file, you can create the infrastructure:</p> <pre><code>terraform init\nterraform apply\n</code></pre> <p>Now you have two servers up and running. The next step is to deploy K3s on each of them using Ansible.</p>"}]}